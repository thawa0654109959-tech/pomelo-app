import streamlit as st
from ultralytics import YOLO
from PIL import Image
import numpy as np

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏õ
st.set_page_config(page_title="Pomelo Scanner", layout="centered")
st.title("üçä ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Å‡∏™‡πâ‡∏°‡πÇ‡∏≠‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞")
st.write("‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡πâ‡∏°‡πÇ‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Å")

# 1. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• (‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå best.pt ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô GitHub ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ)
@st.cache_resource
def load_model():
    return YOLO("best.pt")

try:
    model = load_model()
except Exception as e:
    st.error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏• best.pt ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå")

# 2. ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û (‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
img_file = st.camera_input("‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡πâ‡∏°‡πÇ‡∏≠")

if img_file:
    # ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û
    img = Image.open(img_file)
    
    # 3. ‡πÉ‡∏´‡πâ AI ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
    results = model.predict(img, conf=0.25)
    
    # 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    for r in results:
        # ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏•‡∏á‡∏ö‡∏ô‡∏†‡∏≤‡∏û
        res_plotted = r.plot()
        st.image(res_plotted, caption="‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI", use_container_width=True)
        
        # ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö
        num_boxes = len(r.boxes)
        if num_boxes > 0:
            st.success(f"‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡πâ‡∏°‡πÇ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {num_boxes} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
            
            # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏à‡∏≠
            detected_classes = [model.names[int(c)] for c in r.boxes.cls]
            for name in set(detected_classes):
                count = detected_classes.count(name)
                st.write(f"- {name}: {count} ‡∏•‡∏π‡∏Å")
        else:
            st.warning("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡πâ‡∏°‡πÇ‡∏≠‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á")

st.divider()
st.info("‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏¥‡∏£‡∏±‡∏ä‡∏ç‡∏≤‡∏ì‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ì‡∏∞")